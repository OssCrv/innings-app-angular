<div class="container py-5">
  <div class="text-center mb-5">
    <h1 class="fw-semibold mb-2">Gestión de usuarios</h1>
    <p class="text-muted mb-0">Crea nuevos usuarios y consulta la lista actual directamente desde la API.</p>
  </div>

  <div class="row g-4">
    <div class="col-12 col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-primary text-white">
          <strong>Crear nuevo usuario</strong>
        </div>
        <div class="card-body">
          <div
            *ngIf="submissionFeedback() as feedback"
            class="alert alert-dismissible fade show"
            [class.alert-success]="feedback.type === 'success'"
            [class.alert-danger]="feedback.type === 'error'"
            role="alert"
          >
            {{ feedback.message }}
            <button type="button" class="btn-close" aria-label="Cerrar" (click)="dismissFeedback()"></button>
          </div>

          <form [formGroup]="userForm" (ngSubmit)="submit()" novalidate>
            <div class="mb-3">
              <label for="username" class="form-label">Nombre de usuario</label>
              <input
                type="text"
                id="username"
                class="form-control"
                formControlName="username"
                autocomplete="off"
                [class.is-invalid]="showError('username')"
              />
              <div class="invalid-feedback">
                El nombre de usuario es obligatorio y debe tener como máximo 50 caracteres.
              </div>
            </div>

            <div class="mb-3">
              <label for="password" class="form-label">Contraseña</label>
              <input
                type="password"
                id="password"
                class="form-control"
                formControlName="password"
                autocomplete="new-password"
                [class.is-invalid]="showError('password')"
              />
              <div class="invalid-feedback">
                La contraseña es obligatoria, debe tener al menos 8 caracteres y menos de 255.
              </div>
              <div class="form-text">Usa una combinación segura de letras, números y símbolos.</div>
            </div>

            <div class="mb-3">
              <label for="firstName" class="form-label">Nombre</label>
              <input
                type="text"
                id="firstName"
                class="form-control"
                formControlName="firstName"
                autocomplete="given-name"
                [class.is-invalid]="showError('firstName')"
              />
              <div class="invalid-feedback">El nombre no puede superar los 100 caracteres.</div>
            </div>

            <div class="mb-4">
              <label for="role" class="form-label">Rol</label>
              <select id="role" class="form-select" formControlName="role">
                <option *ngFor="let role of roles" [value]="role">{{ role }}</option>
              </select>
            </div>

            <button type="submit" class="btn btn-primary w-100" [disabled]="!canSubmit()">
              <span *ngIf="submitting()" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
              {{ submitting() ? 'Creando usuario...' : 'Crear usuario' }}
            </button>
          </form>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-header d-flex justify-content-between align-items-center bg-light">
          <strong>Usuarios registrados</strong>
          <button type="button" class="btn btn-sm btn-outline-secondary" (click)="loadUsers()" [disabled]="loadingUsers()">
            <span *ngIf="loadingUsers()" class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
            Actualizar
          </button>
        </div>
        <div class="card-body">
          <div *ngIf="loadError()" class="alert alert-danger" role="alert">
            {{ loadError() }}
            <button type="button" class="btn btn-link btn-sm ps-0" (click)="loadUsers()">Intentar nuevamente</button>
          </div>

          <div *ngIf="loadingUsers()" class="text-center my-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Cargando...</span>
            </div>
          </div>

          <ng-container *ngIf="!loadingUsers() && !loadError()">
            <div *ngIf="users().length; else emptyState" class="table-responsive">
              <table class="table table-striped align-middle mb-0">
                <thead>
                  <tr>
                    <th scope="col">ID</th>
                    <th scope="col">Usuario</th>
                    <th scope="col">Nombre</th>
                    <th scope="col">Rol</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let user of users(); trackBy: trackByUserId">
                    <td>{{ user.id }}</td>
                    <td class="fw-medium">{{ user.username }}</td>
                    <td>{{ user.firstName || '—' }}</td>
                    <td>
                      <span
                        class="badge"
                        [class.bg-primary]="user.role === 'ADMIN'"
                        [class.bg-secondary]="user.role === 'USUARIO'"
                      >
                        {{ user.role }}
                      </span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <ng-template #emptyState>
              <p class="text-muted text-center my-4">Aún no hay usuarios registrados.</p>
            </ng-template>
          </ng-container>
        </div>
      </div>
    </div>
  </div>
</div>
